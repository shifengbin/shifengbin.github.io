<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Debezium | Blog Zone</title>
<meta name=keywords content="数据库监控,Kafka Connect,Debezium"><meta name=description content="Debezium 用于捕获数据库中的更改，以便应用程序可以查看这些更改并对其做出响应。 Debezium 会记录每个数据库表中所有行级别的更改，并将其作为更改事件流记录下来
主流CDC工具：

canal : 监控binlog,支持mysql,社区已不活跃,非首选
debezium : 支持mysql, postgresql, mongodb等十余种数据库,mysql也支持binlog,成熟稳定
flink cdc: 主要应用于大数据,基于debezium,延迟较低

这里选择debezium的理由:

不选canal的原因 只支持mysql,并且社区已不活跃，除了老项目使用新的已经不是首选,在阿里也都边缘化了
不选flink cdc的原因,公司大数据没有flink的项目,增加运维成本，并且需要使用java开发,并不是所有开发都会使用java
选择debezium的原因，debezium成熟稳定,支持多种数据库，经典的使用方式是使用的是kafka connect部署, 我们有自己的kafka,不会增加运维成本, kafka connect是kafka自带的分布式工具，不用搭建额外的平台管理任务,使用消息队列和固定语言解耦,降低开发成本

当我们想监控数据库数据变动时我可以使用一些CDC工具,这里介绍一款配合Kafka使用的Connect插件Debezium,他支持Mysql, PostgreSQL, MongoDB等
能做什么:
1. 解耦数据修改端和使用端,减少应该通知但是没有通知的数据变更的错误,或者手动修改数据库时没有或忘记通知其他端
2. 异构数据库同步数据,比如搜索相关业务,需要数据实时同步，但是要保证数据一致
3. 缓存数据的生成和过期
4. 一些计算任务(数据统计,聚合)

这里我们以MySQL为例
环境
1. Kafka 3.7

2. MySQL 8.0 

3. Debezium Mysql connect Plugin 2.6.2 Final

Mysql
需要开启row格式binlog
[mysqld]
bind-address = 0.0.0.0
binlog_format = ROW
server_id = 1
log_bin = /var/log/mysql/mysql-bin.log
需要以下权限
    GRANT SELECT, RELOAD, SHOW DATABASES, REPLICATION SLAVE, LOCK TABLES, REPLICATION CLIENT ON *.* TO 'user' IDENTIFIED BY 'password';

  
      
          权限
          作用
      
  
  
      
          SELECT
          查询数据,仅在执行快照时使用
      
      
          RELOAD
          允许连接器使用 FLUSH 语句来清除或重新加载内部缓存、刷新表或获取锁。仅在执行快照时使用
      
      
          SHOW DATABASES
          使连接器能够通过发出 SHOW DATABASE 语句来查看数据库名称。仅在执行快照时使用
      
      
          REPLICATION SLAVE
          使连接器能够连接并读取 MySQL 服务器二进制日志
      
      
          REPLICATION CLIENT
          允许连接器使用以下语句：SHOW MASTER STATUS,SHOW SLAVE STATUS,SHOW BINARY LOGS
      
      
          LOCK TABLES
          执行快照时需要锁表
      
  

Debezium
把插件解压到一个目录下,我这里解压到Kafka目录下,创建一个connects目录,解压到这里,解压后我的目录像这样

--kafka
    |--connects
        |--debezium-connector-mysql
在kafka的config文件夹下配置connect-distributed.properties这个文件
修改plugin.path填写connects文件夹路径"><meta name=author content="Fengbin"><link rel=canonical href=https://shifengbin.github.io/posts/db/debezium/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://shifengbin.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://shifengbin.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://shifengbin.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://shifengbin.github.io/apple-touch-icon.png><link rel=mask-icon href=https://shifengbin.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://shifengbin.github.io/posts/db/debezium/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://shifengbin.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Debezium","item":"https://shifengbin.github.io/posts/db/debezium/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Debezium","name":"Debezium","description":"Debezium 用于捕获数据库中的更改，以便应用程序可以查看这些更改并对其做出响应。 Debezium 会记录每个数据库表中所有行级别的更改，并将其作为更改事件流记录下来\n主流CDC工具：\ncanal : 监控binlog,支持mysql,社区已不活跃,非首选 debezium : 支持mysql, postgresql, mongodb等十余种数据库,mysql也支持binlog,成熟稳定 flink cdc: 主要应用于大数据,基于debezium,延迟较低 这里选择debezium的理由:\n不选canal的原因 只支持mysql,并且社区已不活跃，除了老项目使用新的已经不是首选,在阿里也都边缘化了 不选flink cdc的原因,公司大数据没有flink的项目,增加运维成本，并且需要使用java开发,并不是所有开发都会使用java 选择debezium的原因，debezium成熟稳定,支持多种数据库，经典的使用方式是使用的是kafka connect部署, 我们有自己的kafka,不会增加运维成本, kafka connect是kafka自带的分布式工具，不用搭建额外的平台管理任务,使用消息队列和固定语言解耦,降低开发成本 当我们想监控数据库数据变动时我可以使用一些CDC工具,这里介绍一款配合Kafka使用的Connect插件Debezium,他支持Mysql, PostgreSQL, MongoDB等\n能做什么:\n1. 解耦数据修改端和使用端,减少应该通知但是没有通知的数据变更的错误,或者手动修改数据库时没有或忘记通知其他端 2. 异构数据库同步数据,比如搜索相关业务,需要数据实时同步，但是要保证数据一致 3. 缓存数据的生成和过期 4. 一些计算任务(数据统计,聚合) 这里我们以MySQL为例\n环境 1. Kafka 3.7 2. MySQL 8.0 3. Debezium Mysql connect Plugin 2.6.2 Final Mysql 需要开启row格式binlog\n[mysqld] bind-address = 0.0.0.0 binlog_format = ROW server_id = 1 log_bin = /var/log/mysql/mysql-bin.log 需要以下权限\nGRANT SELECT, RELOAD, SHOW DATABASES, REPLICATION SLAVE, LOCK TABLES, REPLICATION CLIENT ON *.* TO \u0026#39;user\u0026#39; IDENTIFIED BY \u0026#39;password\u0026#39;; 权限 作用 SELECT 查询数据,仅在执行快照时使用 RELOAD 允许连接器使用 FLUSH 语句来清除或重新加载内部缓存、刷新表或获取锁。仅在执行快照时使用 SHOW DATABASES 使连接器能够通过发出 SHOW DATABASE 语句来查看数据库名称。仅在执行快照时使用 REPLICATION SLAVE 使连接器能够连接并读取 MySQL 服务器二进制日志 REPLICATION CLIENT 允许连接器使用以下语句：SHOW MASTER STATUS,SHOW SLAVE STATUS,SHOW BINARY LOGS LOCK TABLES 执行快照时需要锁表 Debezium 把插件解压到一个目录下,我这里解压到Kafka目录下,创建一个connects目录,解压到这里,解压后我的目录像这样 --kafka |--connects |--debezium-connector-mysql 在kafka的config文件夹下配置connect-distributed.properties这个文件 修改plugin.path填写connects文件夹路径\n","keywords":["数据库监控","Kafka Connect","Debezium"],"articleBody":"Debezium 用于捕获数据库中的更改，以便应用程序可以查看这些更改并对其做出响应。 Debezium 会记录每个数据库表中所有行级别的更改，并将其作为更改事件流记录下来\n主流CDC工具：\ncanal : 监控binlog,支持mysql,社区已不活跃,非首选 debezium : 支持mysql, postgresql, mongodb等十余种数据库,mysql也支持binlog,成熟稳定 flink cdc: 主要应用于大数据,基于debezium,延迟较低 这里选择debezium的理由:\n不选canal的原因 只支持mysql,并且社区已不活跃，除了老项目使用新的已经不是首选,在阿里也都边缘化了 不选flink cdc的原因,公司大数据没有flink的项目,增加运维成本，并且需要使用java开发,并不是所有开发都会使用java 选择debezium的原因，debezium成熟稳定,支持多种数据库，经典的使用方式是使用的是kafka connect部署, 我们有自己的kafka,不会增加运维成本, kafka connect是kafka自带的分布式工具，不用搭建额外的平台管理任务,使用消息队列和固定语言解耦,降低开发成本 当我们想监控数据库数据变动时我可以使用一些CDC工具,这里介绍一款配合Kafka使用的Connect插件Debezium,他支持Mysql, PostgreSQL, MongoDB等\n能做什么:\n1. 解耦数据修改端和使用端,减少应该通知但是没有通知的数据变更的错误,或者手动修改数据库时没有或忘记通知其他端 2. 异构数据库同步数据,比如搜索相关业务,需要数据实时同步，但是要保证数据一致 3. 缓存数据的生成和过期 4. 一些计算任务(数据统计,聚合) 这里我们以MySQL为例\n环境 1. Kafka 3.7 2. MySQL 8.0 3. Debezium Mysql connect Plugin 2.6.2 Final Mysql 需要开启row格式binlog\n[mysqld] bind-address = 0.0.0.0 binlog_format = ROW server_id = 1 log_bin = /var/log/mysql/mysql-bin.log 需要以下权限\nGRANT SELECT, RELOAD, SHOW DATABASES, REPLICATION SLAVE, LOCK TABLES, REPLICATION CLIENT ON *.* TO 'user' IDENTIFIED BY 'password'; 权限 作用 SELECT 查询数据,仅在执行快照时使用 RELOAD 允许连接器使用 FLUSH 语句来清除或重新加载内部缓存、刷新表或获取锁。仅在执行快照时使用 SHOW DATABASES 使连接器能够通过发出 SHOW DATABASE 语句来查看数据库名称。仅在执行快照时使用 REPLICATION SLAVE 使连接器能够连接并读取 MySQL 服务器二进制日志 REPLICATION CLIENT 允许连接器使用以下语句：SHOW MASTER STATUS,SHOW SLAVE STATUS,SHOW BINARY LOGS LOCK TABLES 执行快照时需要锁表 Debezium 把插件解压到一个目录下,我这里解压到Kafka目录下,创建一个connects目录,解压到这里,解压后我的目录像这样 --kafka |--connects |--debezium-connector-mysql 在kafka的config文件夹下配置connect-distributed.properties这个文件 修改plugin.path填写connects文件夹路径\n这两个值配置为false,json格式不需要这个,否则事件里面key和value会带着冗长的schema信息\nkey.converter.schemas.enable=false value.converter.schemas.enable=false bootstrap.servers这个配置项设置为kafka的地址\n其他选项根据使用情况修改\n完整配置如下\nbootstrap.servers=localhost:9092 group.id=connect-cluster key.converter=org.apache.kafka.connect.json.JsonConverter value.converter=org.apache.kafka.connect.json.JsonConverter #下面这两个只有在json格式的时候才需要配置为false, 其他格式在解析时是需要schema信息的 key.converter.schemas.enable=false value.converter.schemas.enable=false offset.storage.topic=connect-offsets offset.storage.replication.factor=1 config.storage.topic=connect-configs config.storage.replication.factor=1 status.storage.topic=connect-status status.storage.replication.factor=1 offset.flush.interval.ms=10000 listeners=HTTP://:8083 plugin.path=/xxx/kafka/connects 启动分布式connect,./bin/connect-distributed.sh config/connect-distributed.properties\n也可以使用docker镜像方式启动\ndocker run -d \\ --restart=always \\ --name connect \\ -p 8084:8083 \\ -e GROUP_ID=1 \\ -e CONFIG_STORAGE_TOPIC=docker_connect_configs \\ -e OFFSET_STORAGE_TOPIC=docker_connect_offsets \\ -e STATUS_STORAGE_TOPIC=docker_connect_statuses \\ -e CONNECT_STATUS_STORAGE_REPLICATION_FACTOR=3 \\ -e CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR=3 \\ -e CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR=3 \\ -e CONNECT_OFFSET_FLUSH_INTERVAL_MS=10000 \\ -e OFFSET_FLUSH_INTERVAL_MS=10000 \\ -e BOOTSTRAP_SERVERS=xxxx:9092,xxx:9092 \\ -e CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE=false \\ -e CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE=false \\ -e KEY_CONVERTER=org.apache.kafka.connect.json.JsonConverter \\ -e VALUE_CONVERTER=org.apache.kafka.connect.json.JsonConverter \\ quay.io/debezium/connect:2.4 #具体配置项还可以参考容器内docker_entrypoint.sh debezium mysql connect配置\n{ //连接器名称 \"name\": \"connector-test\", \"config\": { //连接器类, mysql connector,需根据版本按文档填写 \"connector.class\": \"io.debezium.connector.mysql.MySqlConnector\", //数据库信息 \"database.hostname\": \"192.168.20.156\", \"database.port\": \"3306\", \"database.user\": \"flink\", \"database.password\": \"flink2023\", //数据库服务器ID,不能重复 \"database.server.id\": \"123123\", //要监控的数据库和表 \"database.include.list\": \"web\", \"table.include.list\": \"web.A_ExpertInfo_1,web.W_ListenRec_(.*)\", //主题前缀,起命名空间作用 \"topic.prefix\": \"mx1\", //快照模式,只获取schema,监听在这之后的数据变化 \"snapshot.mode\": \"schema_only\", //配置schema历史相关信息,内部使用，不需消费 \"schema.history.internal.kafka.bootstrap.servers\": \"localhost:9092\", \"schema.history.internal.kafka.topic\": \"mx.schemahistory.customer\", //是否包含schema变更事件,在\"topic.prefix\" 主题里可以看到变更事件 \"include.schema.changes\": \"true\", //处理不一致的schema的模式, warn打印warn日志而不是停止任务 \"inconsistent.schema.handling.mode\": \"warn\", //不发送墓碑消息 \"tombstones.on.delete\": \"false\", //定义转换器 \"transforms\": \"ListenRec,ListenRecPartition\", //这里配置的是主题路由 \"transforms.ListenRec.type\": \"io.debezium.transforms.ByLogicalTableRouter\", \"transforms.ListenRec.topic.regex\": \"(.*)easyweb_new_trans\\\\.W_ListenRec_(.*)\", \"transforms.ListenRec.topic.replacement\": \"$1ListenRec\", //这里配置的是分区路由 \"transforms.ListenRecPartition.type\": \"io.debezium.transforms.partitions.PartitionRouting\", \"transforms.ListenRecPartition.partition.payload.fields\":\"change.userid\", //这里可以指定before.userid或者after.userid change.userid是自动判断使用before或者after,比如删除后after为空,新建后before为空 \"transforms.ListenRecPartition.partition.topic.num\":\"12\", \"transforms.ListenRecPartition.predicate\":\"listen\", //配置断言,用于指定上面的分区路由,指定如何根据条件将转换应用 \"predicates\":\"listen\", \"predicates.listen.type\":\"org.apache.kafka.connect.transforms.predicates.TopicNameMatches\", \"predicates.listen.pattern\":\"(.*)ListenRec\", //配置自动创建topic, 分区数和副本数, 注意较低的kafka版本不支持,需要手动创建 //设置为-1则使用kafka 配置的默认值 \"topic.creation.default.partitions\": \"1\", \"topic.creation.default.replication.factor\": \"3\", //配置自动创建topic的条件,类似transforms //还可以配置一些其他topic属性,比如cleanup.policy,retention.ms等 \"topic.creation.listen.partitions\":\"12\", \"topic.creation.listen.replication.factor\":\"1\", \"topic.creation.listen.include\":\"listenrec\\\\.Listen\", //还可以配置exclude \"topic.creation.groups\": \"listen\", } } 配置项解析:\nname: 连接器名称\nconnector.class : 连接器类,固定写法\ndatabase.hostname: 数据库地址\ndatabase.port: 数据库端口\ndatabase.user: 数据库用户名\ndatabase.password: 数据库密码\ndatabase.server.id: 数据库服务器ID\ndatabase.include.list: 要监控的数据库类表,逗号分隔\ntopic.prefix: 主题前缀,起命名空间作用\ntable.include.list: 要监控的表名,逗号分隔\nschema.history.internal.kafka.topic: 记录历史变更的主题,内部使用,不需消费,同集群多个任务可共享\nsnapshot.mode:\n1. always: 连接器每次启动时都会执行快照。快照包括捕获schema和数据. 2. initial: 仅当未记录逻辑服务器名称的偏移量或者之前的快照失败时，连接器才会运行快照。快照完成后，连接器开始传输事件记录以进行后续数据库更改。 3. initial_only: 仅当逻辑服务器名称没有记录偏移时，连接器才会运行快照。快照完成后，连接器*停止*。它不会转换为流式传输以从二进制日志中读取更改事件。 4. schema_only: 已弃用，请参阅 no_data 5. no_data: 连接器运行仅捕schema的快照，但不捕获任何表数据。也就是说只捕获启动之后的数据变动,重新启动后会继续之前捕获的位置捕获变动. 6. recovery: 设置此选项可恢复丢失或损坏的数据库schema历史主题。重新启动后，连接器运行快照，从源表重建主题, 如果在上次连接器关闭后将schema更改提交到数据库，请勿使用此模式执行快照 7. never: 当连接器启动时，它不会执行快照，而是立即开始流式传输事件记录以进行后续数据库更改。正在考虑将来弃用此选项，转而使用 no_data 选项。 8. when_needed: 连接器启动后，仅在检测到以下情况之一时才执行快照: 1. 它无法检测到任何主题偏移 2. 先前记录的偏移量指定服务器上不可用的二进制日志位置或GTID 9. configuration_based: 使用此选项，您可以通过一组具有前缀“snapshot.mode.configuration.based”的连接器属性来控制快照行为。 10. custom: 连接器根据 snapshot.mode.custom.name 属性指定的实现执行快照，该属性定义 io.debezium.spi.snapshot.Snapshotter 接口的自定义实现 tombstones.on.delete: 是否在删除事件发生后发送墓碑消息,默认为true,会在删除事件后发送一个value为null的事件\nschema.history.*配置schema历史相关信息,用户解析binlog\ninclude.schema.changes: 是否包含schema变更事件\ninconsistent.schema.handling.mode: 指定连接器应如何对与内部架构表示中不存在的表相关的二进制日志事件做出反应。即内部表示与数据库不一致\n1. fail: 失败抛出一个异常，指示有问题的事件及其二进制日志偏移量，并导致连接器停止, 默认行为 2. warn: warn记录有问题的事件及其二进制日志偏移量并跳过该事件 3. skip: 跳过有问题的事件并且不记录任何内容 transforms: 转换器列表，逗号分隔,可用于把分表的事件转换到一个主题下\n使用curl把配置文件发送给connect\ncurl -X POST -H \"Content-Type: application/json\" --data @mysql.json http://localhost:8083/connectors 其他接口方法请参考\npostman json\n这条语句会把mysql.json这个文件POST给connect, connect收到请求后会启动task启动对mysql的监控\n剩下要做的是编写consumer来消费数据库变动事件就可以了\n注意:\nschema.history.internal.kafka.topic: 1. 这个配置项是connector内部使用，不需消费 2. partition必须为1(因为要保证顺序性) 3. `cleanup.policy` 需要设置为delete(默认是这个),不可以设置为compact(因为需要保留所有历史,不能只保留最新的);`retention.ms` 保留时间设置为9223372036854775807(最大值,默认,或者-1),意味着永不删除; `retention.bytes` 保留大小设置为-1(不限制,默认) 4. 最好是每个task单独创建一个topic，不要共用一个topic，否则可能会导致找不到schema而导致数据丢失 如果*较低版本*不支持设置关于topic的配置，或者不能自动创建，可以手动创建topic: 默认topic: topicPrefix.dbname.table 如果transform指定了replacement,需要按指定的topic创建 问题:\n如果数据量过大导致OOM 如果不想增加内存可以减小offset.flush.interval.ms,但是会提高刷新到kafka的速度,减小max.batch.size会减少批次,处理速度下降 最直接的方法还是增加内存 ","wordCount":"425","inLanguage":"zh","datePublished":"2024-06-28T11:15:28+08:00","dateModified":"2024-06-28T11:15:28+08:00","author":{"@type":"Person","name":"Fengbin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://shifengbin.github.io/posts/db/debezium/"},"publisher":{"@type":"Organization","name":"Blog Zone","logo":{"@type":"ImageObject","url":"https://shifengbin.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://shifengbin.github.io/ accesskey=h title="Blog Zone (Alt + H)">Blog Zone</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://shifengbin.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://shifengbin.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://shifengbin.github.io/contact/ title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://shifengbin.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://shifengbin.github.io/posts/>Posts</a></div><h1 class=post-title>Debezium</h1><div class=post-meta>&lt;span title='2024-06-28 11:15:28 +0800 +0800'>六月 28, 2024&lt;/span>&amp;nbsp;·&amp;nbsp;2 分钟&amp;nbsp;·&amp;nbsp;425 字&amp;nbsp;·&amp;nbsp;Fengbin</div></header><div class=post-content><p>Debezium 用于捕获数据库中的更改，以便应用程序可以查看这些更改并对其做出响应。 Debezium 会记录每个数据库表中所有行级别的更改，并将其作为更改事件流记录下来</p><p>主流CDC工具：</p><ol><li>canal : 监控binlog,支持mysql,社区已不活跃,非首选</li><li>debezium : 支持mysql, postgresql, mongodb等十余种数据库,mysql也支持binlog,成熟稳定</li><li>flink cdc: 主要应用于大数据,基于debezium,延迟较低</li></ol><p>这里选择debezium的理由:</p><ol><li>不选canal的原因 只支持mysql,并且社区已不活跃，除了老项目使用新的已经不是首选,在阿里也都边缘化了</li><li>不选flink cdc的原因,公司大数据没有flink的项目,增加运维成本，并且需要使用java开发,并不是所有开发都会使用java</li><li>选择debezium的原因，debezium成熟稳定,支持多种数据库，经典的使用方式是使用的是kafka connect部署, 我们有自己的kafka,不会增加运维成本, kafka connect是kafka自带的分布式工具，不用搭建额外的平台管理任务,使用消息队列和固定语言解耦,降低开发成本</li></ol><p>当我们想监控数据库数据变动时我可以使用一些CDC工具,这里介绍一款配合Kafka使用的Connect插件Debezium,他支持Mysql, PostgreSQL, MongoDB等</p><p>能做什么:</p><pre><code>1. 解耦数据修改端和使用端,减少应该通知但是没有通知的数据变更的错误,或者手动修改数据库时没有或忘记通知其他端
2. 异构数据库同步数据,比如搜索相关业务,需要数据实时同步，但是要保证数据一致
3. 缓存数据的生成和过期
4. 一些计算任务(数据统计,聚合)
</code></pre><p>这里我们以MySQL为例</p><h2 id=环境>环境<a hidden class=anchor aria-hidden=true href=#环境>#</a></h2><pre><code>1. Kafka 3.7

2. MySQL 8.0 

3. Debezium Mysql connect Plugin 2.6.2 Final
</code></pre><h2 id=mysql>Mysql<a hidden class=anchor aria-hidden=true href=#mysql>#</a></h2><p>需要开启row格式binlog</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>mysqld</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>bind-address</span> <span class=p>=</span> <span class=mf>0.0</span><span class=p>.</span><span class=mf>0.0</span>
</span></span><span class=line><span class=cl><span class=nx>binlog_format</span> <span class=p>=</span> <span class=nx>ROW</span>
</span></span><span class=line><span class=cl><span class=nx>server_id</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nx>log_bin</span> <span class=p>=</span> <span class=err>/</span><span class=nx>var</span><span class=err>/</span><span class=nx>log</span><span class=err>/</span><span class=nx>mysql</span><span class=err>/</span><span class=nx>mysql-bin</span><span class=p>.</span><span class=nx>log</span>
</span></span></code></pre></div><p>需要以下权限</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=w>    </span><span class=k>GRANT</span><span class=w> </span><span class=k>SELECT</span><span class=p>,</span><span class=w> </span><span class=n>RELOAD</span><span class=p>,</span><span class=w> </span><span class=k>SHOW</span><span class=w> </span><span class=n>DATABASES</span><span class=p>,</span><span class=w> </span><span class=n>REPLICATION</span><span class=w> </span><span class=n>SLAVE</span><span class=p>,</span><span class=w> </span><span class=k>LOCK</span><span class=w> </span><span class=n>TABLES</span><span class=p>,</span><span class=w> </span><span class=n>REPLICATION</span><span class=w> </span><span class=n>CLIENT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=o>*</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=s1>&#39;user&#39;</span><span class=w> </span><span class=n>IDENTIFIED</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=s1>&#39;password&#39;</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><table><thead><tr><th>权限</th><th>作用</th></tr></thead><tbody><tr><td>SELECT</td><td>查询数据,仅在执行快照时使用</td></tr><tr><td>RELOAD</td><td>允许连接器使用 FLUSH 语句来清除或重新加载内部缓存、刷新表或获取锁。仅在执行快照时使用</td></tr><tr><td>SHOW DATABASES</td><td>使连接器能够通过发出 SHOW DATABASE 语句来查看数据库名称。仅在执行快照时使用</td></tr><tr><td>REPLICATION SLAVE</td><td>使连接器能够连接并读取 MySQL 服务器二进制日志</td></tr><tr><td>REPLICATION CLIENT</td><td>允许连接器使用以下语句：SHOW MASTER STATUS,SHOW SLAVE STATUS,SHOW BINARY LOGS</td></tr><tr><td>LOCK TABLES</td><td>执行快照时需要锁表</td></tr></tbody></table><h2 id=debezium>Debezium<a hidden class=anchor aria-hidden=true href=#debezium>#</a></h2><pre><code>把插件解压到一个目录下,我这里解压到Kafka目录下,创建一个connects目录,解压到这里,解压后我的目录像这样
</code></pre><pre tabindex=0><code>--kafka
    |--connects
        |--debezium-connector-mysql
</code></pre><p>在kafka的config文件夹下配置<code>connect-distributed.properties</code>这个文件
修改plugin.path填写connects文件夹路径</p><p>这两个值配置为false,json格式不需要这个,否则事件里面key和value会带着冗长的schema信息</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>key</span><span class=p>.</span><span class=nx>converter</span><span class=p>.</span><span class=nx>schemas</span><span class=p>.</span><span class=nx>enable</span><span class=p>=</span><span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=nx>value</span><span class=p>.</span><span class=nx>converter</span><span class=p>.</span><span class=nx>schemas</span><span class=p>.</span><span class=nx>enable</span><span class=p>=</span><span class=kc>false</span>
</span></span></code></pre></div><p><code>bootstrap.servers</code>这个配置项设置为kafka的地址</p><p>其他选项根据使用情况修改</p><p>完整配置如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>.</span><span class=nx>servers</span><span class=p>=</span><span class=nx>localhost</span><span class=err>:</span><span class=mi>9092</span>
</span></span><span class=line><span class=cl><span class=nx>group</span><span class=p>.</span><span class=nx>id</span><span class=p>=</span><span class=nx>connect-cluster</span>
</span></span><span class=line><span class=cl><span class=nx>key</span><span class=p>.</span><span class=nx>converter</span><span class=p>=</span><span class=nx>org</span><span class=p>.</span><span class=nx>apache</span><span class=p>.</span><span class=nx>kafka</span><span class=p>.</span><span class=nx>connect</span><span class=p>.</span><span class=nx>json</span><span class=p>.</span><span class=nx>JsonConverter</span>
</span></span><span class=line><span class=cl><span class=nx>value</span><span class=p>.</span><span class=nx>converter</span><span class=p>=</span><span class=nx>org</span><span class=p>.</span><span class=nx>apache</span><span class=p>.</span><span class=nx>kafka</span><span class=p>.</span><span class=nx>connect</span><span class=p>.</span><span class=nx>json</span><span class=p>.</span><span class=nx>JsonConverter</span>
</span></span><span class=line><span class=cl><span class=c>#下面这两个只有在json格式的时候才需要配置为false, 其他格式在解析时是需要schema信息的</span>
</span></span><span class=line><span class=cl><span class=nx>key</span><span class=p>.</span><span class=nx>converter</span><span class=p>.</span><span class=nx>schemas</span><span class=p>.</span><span class=nx>enable</span><span class=p>=</span><span class=kc>false</span>  
</span></span><span class=line><span class=cl><span class=nx>value</span><span class=p>.</span><span class=nx>converter</span><span class=p>.</span><span class=nx>schemas</span><span class=p>.</span><span class=nx>enable</span><span class=p>=</span><span class=kc>false</span>
</span></span><span class=line><span class=cl><span class=nx>offset</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>topic</span><span class=p>=</span><span class=nx>connect-offsets</span>
</span></span><span class=line><span class=cl><span class=nx>offset</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>replication</span><span class=p>.</span><span class=nx>factor</span><span class=p>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nx>config</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>topic</span><span class=p>=</span><span class=nx>connect-configs</span>
</span></span><span class=line><span class=cl><span class=nx>config</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>replication</span><span class=p>.</span><span class=nx>factor</span><span class=p>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nx>status</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>topic</span><span class=p>=</span><span class=nx>connect-status</span>
</span></span><span class=line><span class=cl><span class=nx>status</span><span class=p>.</span><span class=nx>storage</span><span class=p>.</span><span class=nx>replication</span><span class=p>.</span><span class=nx>factor</span><span class=p>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=nx>offset</span><span class=p>.</span><span class=nx>flush</span><span class=p>.</span><span class=nx>interval</span><span class=p>.</span><span class=nx>ms</span><span class=p>=</span><span class=mi>10000</span>
</span></span><span class=line><span class=cl><span class=nx>listeners</span><span class=p>=</span><span class=nx>HTTP</span><span class=err>://:</span><span class=mi>8083</span>
</span></span><span class=line><span class=cl><span class=nx>plugin</span><span class=p>.</span><span class=nx>path</span><span class=p>=</span><span class=err>/</span><span class=nx>xxx</span><span class=err>/</span><span class=nx>kafka</span><span class=err>/</span><span class=nx>connects</span>
</span></span></code></pre></div><p>启动分布式connect,<code>./bin/connect-distributed.sh config/connect-distributed.properties</code></p><p>也可以使用docker镜像方式启动</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker run  -d <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --restart<span class=o>=</span>always <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --name connect <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -p 8084:8083 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>GROUP_ID</span><span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>CONFIG_STORAGE_TOPIC</span><span class=o>=</span>docker_connect_configs <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>OFFSET_STORAGE_TOPIC</span><span class=o>=</span>docker_connect_offsets <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>STATUS_STORAGE_TOPIC</span><span class=o>=</span>docker_connect_statuses <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>CONNECT_STATUS_STORAGE_REPLICATION_FACTOR</span><span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR</span><span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR</span><span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>CONNECT_OFFSET_FLUSH_INTERVAL_MS</span><span class=o>=</span><span class=m>10000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>OFFSET_FLUSH_INTERVAL_MS</span><span class=o>=</span><span class=m>10000</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>BOOTSTRAP_SERVERS</span><span class=o>=</span>xxxx:9092,xxx:9092 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE</span><span class=o>=</span><span class=nb>false</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE</span><span class=o>=</span><span class=nb>false</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>KEY_CONVERTER</span><span class=o>=</span>org.apache.kafka.connect.json.JsonConverter <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -e <span class=nv>VALUE_CONVERTER</span><span class=o>=</span>org.apache.kafka.connect.json.JsonConverter <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    quay.io/debezium/connect:2.4
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#具体配置项还可以参考容器内docker_entrypoint.sh</span>
</span></span></code></pre></div><p>debezium mysql connect配置</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>//连接器名称
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;connector-test&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;config&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>//连接器类, mysql connector,需根据版本按文档填写
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;connector.class&#34;</span><span class=p>:</span> <span class=s2>&#34;io.debezium.connector.mysql.MySqlConnector&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>//数据库信息
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;database.hostname&#34;</span><span class=p>:</span> <span class=s2>&#34;192.168.20.156&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;database.port&#34;</span><span class=p>:</span> <span class=s2>&#34;3306&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;database.user&#34;</span><span class=p>:</span> <span class=s2>&#34;flink&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;database.password&#34;</span><span class=p>:</span> <span class=s2>&#34;flink2023&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>//数据库服务器ID,不能重复
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;database.server.id&#34;</span><span class=p>:</span> <span class=s2>&#34;123123&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//要监控的数据库和表
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;database.include.list&#34;</span><span class=p>:</span> <span class=s2>&#34;web&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;table.include.list&#34;</span><span class=p>:</span> <span class=s2>&#34;web.A_ExpertInfo_1,web.W_ListenRec_(.*)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//主题前缀,起命名空间作用
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;topic.prefix&#34;</span><span class=p>:</span> <span class=s2>&#34;mx1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>//快照模式,只获取schema,监听在这之后的数据变化
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;snapshot.mode&#34;</span><span class=p>:</span> <span class=s2>&#34;schema_only&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//配置schema历史相关信息,内部使用，不需消费
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;schema.history.internal.kafka.bootstrap.servers&#34;</span><span class=p>:</span> <span class=s2>&#34;localhost:9092&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;schema.history.internal.kafka.topic&#34;</span><span class=p>:</span> <span class=s2>&#34;mx.schemahistory.customer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>//是否包含schema变更事件,在&#34;topic.prefix&#34; 主题里可以看到变更事件
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;include.schema.changes&#34;</span><span class=p>:</span> <span class=s2>&#34;true&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//处理不一致的schema的模式, warn打印warn日志而不是停止任务
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;inconsistent.schema.handling.mode&#34;</span><span class=p>:</span> <span class=s2>&#34;warn&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>//不发送墓碑消息
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;tombstones.on.delete&#34;</span><span class=p>:</span> <span class=s2>&#34;false&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=c1>//定义转换器
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;transforms&#34;</span><span class=p>:</span> <span class=s2>&#34;ListenRec,ListenRecPartition&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//这里配置的是主题路由
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;transforms.ListenRec.type&#34;</span><span class=p>:</span> <span class=s2>&#34;io.debezium.transforms.ByLogicalTableRouter&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;transforms.ListenRec.topic.regex&#34;</span><span class=p>:</span> <span class=s2>&#34;(.*)easyweb_new_trans\\.W_ListenRec_(.*)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;transforms.ListenRec.topic.replacement&#34;</span><span class=p>:</span> <span class=s2>&#34;$1ListenRec&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//这里配置的是分区路由
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;transforms.ListenRecPartition.type&#34;</span><span class=p>:</span> <span class=s2>&#34;io.debezium.transforms.partitions.PartitionRouting&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;transforms.ListenRecPartition.partition.payload.fields&#34;</span><span class=p>:</span><span class=s2>&#34;change.userid&#34;</span><span class=p>,</span> <span class=c1>//这里可以指定before.userid或者after.userid change.userid是自动判断使用before或者after,比如删除后after为空,新建后before为空
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;transforms.ListenRecPartition.partition.topic.num&#34;</span><span class=p>:</span><span class=s2>&#34;12&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;transforms.ListenRecPartition.predicate&#34;</span><span class=p>:</span><span class=s2>&#34;listen&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//配置断言,用于指定上面的分区路由,指定如何根据条件将转换应用
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;predicates&#34;</span><span class=p>:</span><span class=s2>&#34;listen&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;predicates.listen.type&#34;</span><span class=p>:</span><span class=s2>&#34;org.apache.kafka.connect.transforms.predicates.TopicNameMatches&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;predicates.listen.pattern&#34;</span><span class=p>:</span><span class=s2>&#34;(.*)ListenRec&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//配置自动创建topic, 分区数和副本数, 注意较低的kafka版本不支持,需要手动创建
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>//设置为-1则使用kafka 配置的默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;topic.creation.default.partitions&#34;</span><span class=p>:</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;topic.creation.default.replication.factor&#34;</span><span class=p>:</span> <span class=s2>&#34;3&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//配置自动创建topic的条件,类似transforms
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>//还可以配置一些其他topic属性,比如cleanup.policy,retention.ms等
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;topic.creation.listen.partitions&#34;</span><span class=p>:</span><span class=s2>&#34;12&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;topic.creation.listen.replication.factor&#34;</span><span class=p>:</span><span class=s2>&#34;1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;topic.creation.listen.include&#34;</span><span class=p>:</span><span class=s2>&#34;listenrec\\.Listen&#34;</span><span class=p>,</span> <span class=c1>//还可以配置exclude
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nt>&#34;topic.creation.groups&#34;</span><span class=p>:</span> <span class=s2>&#34;listen&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>配置项解析:</p><p>name: 连接器名称</p><p>connector.class : 连接器类,固定写法</p><p>database.hostname: 数据库地址</p><p>database.port: 数据库端口</p><p>database.user: 数据库用户名</p><p>database.password: 数据库密码</p><p>database.server.id: 数据库服务器ID</p><p>database.include.list: 要监控的数据库类表,逗号分隔</p><p>topic.prefix: 主题前缀,起命名空间作用</p><p>table.include.list: 要监控的表名,逗号分隔</p><p>schema.history.internal.kafka.topic: 记录历史变更的主题,内部使用,不需消费,同集群多个任务可共享</p><p>snapshot.mode:</p><pre><code>1. always: 连接器每次启动时都会执行快照。快照包括捕获schema和数据.

2. initial: 仅当未记录逻辑服务器名称的偏移量或者之前的快照失败时，连接器才会运行快照。快照完成后，连接器开始传输事件记录以进行后续数据库更改。

3. initial_only: 仅当逻辑服务器名称没有记录偏移时，连接器才会运行快照。快照完成后，连接器*停止*。它不会转换为流式传输以从二进制日志中读取更改事件。

4. schema_only: 已弃用，请参阅 no_data

5. no_data: 连接器运行仅捕schema的快照，但不捕获任何表数据。也就是说只捕获启动之后的数据变动,重新启动后会继续之前捕获的位置捕获变动.

6. recovery: 设置此选项可恢复丢失或损坏的数据库schema历史主题。重新启动后，连接器运行快照，从源表重建主题, 如果在上次连接器关闭后将schema更改提交到数据库，请勿使用此模式执行快照

7. never: 当连接器启动时，它不会执行快照，而是立即开始流式传输事件记录以进行后续数据库更改。正在考虑将来弃用此选项，转而使用 no_data 选项。

8. when_needed: 连接器启动后，仅在检测到以下情况之一时才执行快照: 1.  它无法检测到任何主题偏移 2. 先前记录的偏移量指定服务器上不可用的二进制日志位置或GTID

9.  configuration_based:  使用此选项，您可以通过一组具有前缀“snapshot.mode.configuration.based”的连接器属性来控制快照行为。

10. custom: 连接器根据 snapshot.mode.custom.name 属性指定的实现执行快照，该属性定义 io.debezium.spi.snapshot.Snapshotter 接口的自定义实现
</code></pre><p>tombstones.on.delete: 是否在删除事件发生后发送墓碑消息,默认为true,会在删除事件后发送一个value为null的事件</p><p>schema.history.*配置schema历史相关信息,用户解析binlog</p><p>include.schema.changes: 是否包含schema变更事件</p><p>inconsistent.schema.handling.mode: 指定连接器应如何对与内部架构表示中不存在的表相关的二进制日志事件做出反应。即内部表示与数据库不一致</p><pre><code>1. fail: 失败抛出一个异常，指示有问题的事件及其二进制日志偏移量，并导致连接器停止, 默认行为

2. warn: warn记录有问题的事件及其二进制日志偏移量并跳过该事件

3. skip: 跳过有问题的事件并且不记录任何内容
</code></pre><p>transforms: 转换器列表，逗号分隔,可用于把分表的事件转换到一个主题下</p><p>使用curl把配置文件发送给connect</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -X POST -H <span class=s2>&#34;Content-Type: application/json&#34;</span> --data @mysql.json http://localhost:8083/connectors
</span></span></code></pre></div><p>其他接口方法请参考</p><p><a href=/json/kafka_connector.postman_collection.json>postman json</a></p><p>这条语句会把mysql.json这个文件POST给connect, connect收到请求后会启动task启动对mysql的监控</p><p>剩下要做的是编写consumer来消费数据库变动事件就可以了</p><p>注意:</p><pre><code>schema.history.internal.kafka.topic:

1. 这个配置项是connector内部使用，不需消费
2. partition必须为1(因为要保证顺序性)
3. `cleanup.policy` 需要设置为delete(默认是这个),不可以设置为compact(因为需要保留所有历史,不能只保留最新的);`retention.ms` 保留时间设置为9223372036854775807(最大值,默认,或者-1),意味着永不删除; `retention.bytes` 保留大小设置为-1(不限制,默认)
4. 最好是每个task单独创建一个topic，不要共用一个topic，否则可能会导致找不到schema而导致数据丢失

如果*较低版本*不支持设置关于topic的配置，或者不能自动创建，可以手动创建topic:
    默认topic: topicPrefix.dbname.table
    如果transform指定了replacement,需要按指定的topic创建
</code></pre><p>问题:</p><ol><li>如果数据量过大导致OOM<ol><li>如果不想增加内存可以减小offset.flush.interval.ms,但是会提高刷新到kafka的速度,减小max.batch.size会减少批次,处理速度下降</li><li>最直接的方法还是增加内存</li></ol></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=https://shifengbin.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9B%91%E6%8E%A7/>数据库监控</a></li><li><a href=https://shifengbin.github.io/tags/kafka-connect/>Kafka Connect</a></li><li><a href=https://shifengbin.github.io/tags/debezium/>Debezium</a></li></ul><nav class=paginav><a class=prev href=https://shifengbin.github.io/posts/mq/kafka_kraft/><span class=title>« 上一页</span><br><span>Kafka使用kraft搭建集群</span>
</a><a class=next href=https://shifengbin.github.io/posts/go/deadlock/><span class=title>下一页 »</span><br><span>Deadlock检测时机</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Debezium on twitter" href="https://twitter.com/intent/tweet/?text=Debezium&amp;url=https%3a%2f%2fshifengbin.github.io%2fposts%2fdb%2fdebezium%2f&amp;hashtags=%e6%95%b0%e6%8d%ae%e5%ba%93%e7%9b%91%e6%8e%a7%2cKafkaConnect%2cDebezium"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Debezium on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fshifengbin.github.io%2fposts%2fdb%2fdebezium%2f&amp;title=Debezium&amp;summary=Debezium&amp;source=https%3a%2f%2fshifengbin.github.io%2fposts%2fdb%2fdebezium%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Debezium on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fshifengbin.github.io%2fposts%2fdb%2fdebezium%2f&title=Debezium"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Debezium on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fshifengbin.github.io%2fposts%2fdb%2fdebezium%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Debezium on whatsapp" href="https://api.whatsapp.com/send?text=Debezium%20-%20https%3a%2f%2fshifengbin.github.io%2fposts%2fdb%2fdebezium%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a><a target=_blank rel="noopener noreferrer" aria-label="share Debezium on telegram" href="https://telegram.me/share/url?text=Debezium&amp;url=https%3a%2f%2fshifengbin.github.io%2fposts%2fdb%2fdebezium%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://shifengbin.github.io/>Blog Zone</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{let e="dark";document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light"),e="light"):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"),e="dark");for(let t of window.themeOberver)t(e)})</script></body></html>