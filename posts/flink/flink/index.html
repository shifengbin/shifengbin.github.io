<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Flink k8s中的使用 | Blog Zone</title>
<meta name=keywords content="flink"><meta name=description content='flink使用
本文讲解的是在k8s中使用flink,摆脱yarn, hdfs等大数据组件
k8s 部署(手动部署HA模式)
想要实现K8S的HA模式必须要有几个条件

要有能查看,添加,修改,删除configmap权限的账户
# flink-service-account.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: flink-sa
  namespace: flink-namespace

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: flink-role
  namespace: flink-namespace
rules:
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["create", "get", "list", "watch", "update", "delete", "patch"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["services"]
  verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: flink-role-binding
  namespace: flink-namespace
subjects:
- kind: ServiceAccount
  name: flink-sa
  namespace: flink-namespace
roleRef:
  kind: Role
  name: flink-role
  apiGroup: rbac.authorization.k8s.io

配置文件开启高可用模式为kubernetes和配置集群id,检查点和重启策略
    #高可用配置
    high-availability.type: kubernetes
    high-availability.storageDir: file:///flink/storage/ha
    #集群信息
    kubernetes.cluster-id: flink-cluster-001
    kubernetes.namespace: flink-namespace
    #状态后端,检查点保存点默认位置,可以配置为oss
    state.backend.type: filesystem   
    state.checkpoints.dir: file:///flink/storage/checkpoints
    state.savepoints.dir: file:///flink/storage/savepoints
    #检查点执行配置
    execution.checkpointing.interval: 20s
    execution.checkpointing.max-concurrent-checkpoints: 1
    execution.checkpointing.mode: EXACTLY_ONCE
    execution.checkpointing.timeout: 1min
    #重启策略
    restart-strategy.type: fixed-delay
    restart-strategy.fixed-delay.attempts: 10
    restart-strategy.fixed-delay.delay: 30s


session模式
创建命名空间
我们把flink部署到名称为flink-namespace的命名空间中(创建命名空间kubectl create namespace flink-namespace)'><meta name=author content="Fengbin"><link rel=canonical href=https://shifengbin.github.io/posts/flink/flink/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://shifengbin.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://shifengbin.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://shifengbin.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://shifengbin.github.io/apple-touch-icon.png><link rel=mask-icon href=https://shifengbin.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://shifengbin.github.io/posts/flink/flink/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://shifengbin.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Flink k8s中的使用","item":"https://shifengbin.github.io/posts/flink/flink/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Flink k8s中的使用","name":"Flink k8s中的使用","description":"flink使用 本文讲解的是在k8s中使用flink,摆脱yarn, hdfs等大数据组件\nk8s 部署(手动部署HA模式) 想要实现K8S的HA模式必须要有几个条件\n要有能查看,添加,修改,删除configmap权限的账户 # flink-service-account.yaml apiVersion: v1 kind: ServiceAccount metadata: name: flink-sa namespace: flink-namespace --- apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: flink-role namespace: flink-namespace rules: - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;configmaps\u0026#34;] verbs: [\u0026#34;create\u0026#34;, \u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;, \u0026#34;update\u0026#34;, \u0026#34;delete\u0026#34;, \u0026#34;patch\u0026#34;] - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;pods\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] - apiGroups: [\u0026#34;\u0026#34;] resources: [\u0026#34;services\u0026#34;] verbs: [\u0026#34;get\u0026#34;, \u0026#34;list\u0026#34;, \u0026#34;watch\u0026#34;] --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: flink-role-binding namespace: flink-namespace subjects: - kind: ServiceAccount name: flink-sa namespace: flink-namespace roleRef: kind: Role name: flink-role apiGroup: rbac.authorization.k8s.io 配置文件开启高可用模式为kubernetes和配置集群id,检查点和重启策略 #高可用配置 high-availability.type: kubernetes high-availability.storageDir: file:///flink/storage/ha #集群信息 kubernetes.cluster-id: flink-cluster-001 kubernetes.namespace: flink-namespace #状态后端,检查点保存点默认位置,可以配置为oss state.backend.type: filesystem state.checkpoints.dir: file:///flink/storage/checkpoints state.savepoints.dir: file:///flink/storage/savepoints #检查点执行配置 execution.checkpointing.interval: 20s execution.checkpointing.max-concurrent-checkpoints: 1 execution.checkpointing.mode: EXACTLY_ONCE execution.checkpointing.timeout: 1min #重启策略 restart-strategy.type: fixed-delay restart-strategy.fixed-delay.attempts: 10 restart-strategy.fixed-delay.delay: 30s session模式 创建命名空间 我们把flink部署到名称为flink-namespace的命名空间中(创建命名空间kubectl create namespace flink-namespace)\n","keywords":["flink"],"articleBody":"flink使用 本文讲解的是在k8s中使用flink,摆脱yarn, hdfs等大数据组件\nk8s 部署(手动部署HA模式) 想要实现K8S的HA模式必须要有几个条件\n要有能查看,添加,修改,删除configmap权限的账户 # flink-service-account.yaml apiVersion: v1 kind: ServiceAccount metadata: name: flink-sa namespace: flink-namespace --- apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: flink-role namespace: flink-namespace rules: - apiGroups: [\"\"] resources: [\"configmaps\"] verbs: [\"create\", \"get\", \"list\", \"watch\", \"update\", \"delete\", \"patch\"] - apiGroups: [\"\"] resources: [\"pods\"] verbs: [\"get\", \"list\", \"watch\"] - apiGroups: [\"\"] resources: [\"services\"] verbs: [\"get\", \"list\", \"watch\"] --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: flink-role-binding namespace: flink-namespace subjects: - kind: ServiceAccount name: flink-sa namespace: flink-namespace roleRef: kind: Role name: flink-role apiGroup: rbac.authorization.k8s.io 配置文件开启高可用模式为kubernetes和配置集群id,检查点和重启策略 #高可用配置 high-availability.type: kubernetes high-availability.storageDir: file:///flink/storage/ha #集群信息 kubernetes.cluster-id: flink-cluster-001 kubernetes.namespace: flink-namespace #状态后端,检查点保存点默认位置,可以配置为oss state.backend.type: filesystem state.checkpoints.dir: file:///flink/storage/checkpoints state.savepoints.dir: file:///flink/storage/savepoints #检查点执行配置 execution.checkpointing.interval: 20s execution.checkpointing.max-concurrent-checkpoints: 1 execution.checkpointing.mode: EXACTLY_ONCE execution.checkpointing.timeout: 1min #重启策略 restart-strategy.type: fixed-delay restart-strategy.fixed-delay.attempts: 10 restart-strategy.fixed-delay.delay: 30s session模式 创建命名空间 我们把flink部署到名称为flink-namespace的命名空间中(创建命名空间kubectl create namespace flink-namespace)\n创建用户并绑定权限(kubectl create -f flink-service-account.yaml -n flink-namespace) # flink-service-account.yaml apiVersion: v1 kind: ServiceAccount metadata: name: flink-sa namespace: flink-namespace --- apiVersion: rbac.authorization.k8s.io/v1 kind: Role metadata: name: flink-role namespace: flink-namespace rules: - apiGroups: [\"\"] resources: [\"configmaps\"] verbs: [\"create\", \"get\", \"list\", \"watch\", \"update\", \"delete\", \"patch\"] - apiGroups: [\"\"] resources: [\"pods\"] verbs: [\"get\", \"list\", \"watch\"] - apiGroups: [\"\"] resources: [\"services\"] verbs: [\"get\", \"list\", \"watch\"] --- apiVersion: rbac.authorization.k8s.io/v1 kind: RoleBinding metadata: name: flink-role-binding namespace: flink-namespace subjects: - kind: ServiceAccount name: flink-sa namespace: flink-namespace roleRef: kind: Role name: flink-role apiGroup: rbac.authorization.k8s.io 配置通过configmap来配置 apiVersion: v1 kind: ConfigMap metadata: name: flink-config labels: app: flink data: config.yaml: |+ jobmanager.rpc.address: flink-jobmanager taskmanager.numberOfTaskSlots: 1 blob.server.port: 6124 jobmanager.rpc.port: 6123 taskmanager.rpc.port: 6122 jobmanager.memory.process.size: 1600m taskmanager.memory.process.size: 1728m parallelism.default: 1 high-availability.type: kubernetes high-availability.storageDir: file:///flink/storage/ha kubernetes.cluster-id: flink-cluster-001 kubernetes.namespace: flink-namespace state.backend.type: filesystem state.checkpoints.dir: file:///flink/storage/checkpoints state.savepoints.dir: file:///flink/storage/savepoints execution.checkpointing.interval: 20s execution.checkpointing.max-concurrent-checkpoints: 1 execution.checkpointing.mode: EXACTLY_ONCE execution.checkpointing.timeout: 1min restart-strategy.type: fixed-delay restart-strategy.fixed-delay.attempts: 10 restart-strategy.fixed-delay.delay: 30s log4j-console.properties: |+ # 如下配置会同时影响用户代码和 Flink 的日志行为 rootLogger.level = INFO rootLogger.appenderRef.console.ref = ConsoleAppender rootLogger.appenderRef.rolling.ref = RollingFileAppender # 如果你只想改变 Flink 的日志行为则可以取消如下的注释部分 #logger.flink.name = org.apache.flink #logger.flink.level = INFO # 下面几行将公共 libraries 或 connectors 的日志级别保持在 INFO 级别。 # root logger 的配置不会覆盖此处配置。 # 你必须手动修改这里的日志级别。 logger.pekko.name = org.apache.pekko logger.pekko.level = INFO logger.kafka.name= org.apache.kafka logger.kafka.level = INFO logger.hadoop.name = org.apache.hadoop logger.hadoop.level = INFO logger.zookeeper.name = org.apache.zookeeper logger.zookeeper.level = INFO # 将所有 info 级别的日志输出到 console appender.console.name = ConsoleAppender appender.console.type = CONSOLE appender.console.layout.type = PatternLayout appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n # 将所有 info 级别的日志输出到指定的 rolling file appender.rolling.name = RollingFileAppender appender.rolling.type = RollingFile appender.rolling.append = false appender.rolling.fileName = ${sys:log.file} appender.rolling.filePattern = ${sys:log.file}.%i appender.rolling.layout.type = PatternLayout appender.rolling.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n appender.rolling.policies.type = Policies appender.rolling.policies.size.type = SizeBasedTriggeringPolicy appender.rolling.policies.size.size=100MB appender.rolling.strategy.type = DefaultRolloverStrategy appender.rolling.strategy.max = 10 # 关闭 Netty channel handler 中不相关的（错误）警告 logger.netty.name = org.jboss.netty.channel.DefaultChannelPipeline logger.netty.level = OFF 创建jobmanager(kubectl apply -f jobmanager-deployment.yaml -n flink-namespace) # jobmanager-deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: flink-jobmanager labels: app: flink component: jobmanager spec: replicas: 2 # 如果需要更快的恢复，可以设置为2，但通常1个就够了 selector: matchLabels: app: flink component: jobmanager template: metadata: labels: app: flink component: jobmanager spec: serviceAccountName: flink-sa containers: - name: jobmanager image: apache/flink:1.20.2-scala_2.12 env: - name: POD_IP valueFrom: fieldRef: apiVersion: v1 fieldPath: status.podIP # 下面的 args 参数会使用 POD_IP 对应的值覆盖 config map 中 jobmanager.rpc.address 的属性值。 args: [\"jobmanager\", \"$(POD_IP)\"] ports: - containerPort: 6123 name: rpc - containerPort: 6124 name: blob - containerPort: 8081 name: webui livenessProbe: tcpSocket: port: 6123 initialDelaySeconds: 30 periodSeconds: 60 volumeMounts: - name: flink-config-volume mountPath: /opt/flink/conf - name: flink-storage mountPath: /flink/storage resources: requests: memory: \"1Gi\" cpu: \"1\" limits: memory: \"2Gi\" cpu: \"2\" securityContext: runAsUser: 9999 volumes: - name: flink-config-volume configMap: name: flink-config items: - key: config.yaml path: config.yaml - key: log4j-console.properties path: log4j-console.properties - name: flink-storage hostPath: path: /run/desktop/mnt/host/e/flink type: DirectoryOrCreate 创建 taskmanager(kubectl apply -f flink-taskmanager.yaml -n flink-namespace) # taskmanager-deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: flink-taskmanager labels: app: flink component: taskmanager spec: replicas: 2 # 根据您的需求设置 selector: matchLabels: app: flink component: taskmanager template: metadata: labels: app: flink component: taskmanager spec: serviceAccountName: flink-sa containers: - name: taskmanager image: apache/flink:1.20.2-scala_2.12 args: [\"taskmanager\"] ports: - containerPort: 6122 name: rpc livenessProbe: tcpSocket: port: 6122 initialDelaySeconds: 30 periodSeconds: 60 volumeMounts: - name: flink-config-volume mountPath: /opt/flink/conf - name: flink-storage mountPath: /flink/storage resources: requests: memory: \"1Gi\" cpu: \"1\" limits: memory: \"2Gi\" cpu: \"2\" securityContext: runAsUser: 9999 volumes: - name: flink-config-volume configMap: name: flink-config items: - key: config.yaml path: config.yaml - key: log4j-console.properties path: log4j-console.properties - name: flink-storage hostPath: path: /run/desktop/mnt/host/e/flink type: DirectoryOrCreate 创建service方便访问 # jobmanager-service.yaml apiVersion: v1 kind: Service metadata: name: flink-jobmanager labels: app: flink component: jobmanager spec: ports: - name: rpc port: 6123 - name: blob port: 6124 - name: webui port: 8081 selector: app: flink component: jobmanager --- apiVersion: v1 kind: Service metadata: name: flink-jobmanager-rest spec: type: NodePort ports: - name: rest port: 8081 targetPort: 8081 nodePort: 30081 selector: app: flink component: jobmanager application部署(oss方式模式) 用户要求和session模式一致\n创建配置文件(configmap) apiVersion: v1 kind: ConfigMap metadata: name: flink-config labels: app: flink data: config.yaml: |+ jobmanager.rpc.address: flink-jobmanager taskmanager.numberOfTaskSlots: 1 blob.server.port: 6124 jobmanager.rpc.port: 6123 taskmanager.rpc.port: 6122 jobmanager.memory.process.size: 1600m taskmanager.memory.process.size: 1728m #这里是阿里云oss的配置 fs.oss.accessKeyId: xxx fs.oss.accessKeySecret: xxx fs.oss.endpoint: xxx parallelism.default: 1 high-availability.type: kubernetes high-availability.storageDir: oss://bucketname/flink/storage/ha kubernetes.cluster-id: flink-cluster-001 kubernetes.namespace: flink-namespace state.backend.type: filesystem state.checkpoints.dir: oss://bucketname/flink/storage/checkpoints state.savepoints.dir: oss://bucketname/flink/storage/savepoints execution.checkpointing.interval: 20s execution.checkpointing.max-concurrent-checkpoints: 1 execution.checkpointing.mode: EXACTLY_ONCE execution.checkpointing.timeout: 1min restart-strategy.type: fixed-delay restart-strategy.fixed-delay.attempts: 10 restart-strategy.fixed-delay.delay: 30s log4j-console.properties: |+ # 如下配置会同时影响用户代码和 Flink 的日志行为 rootLogger.level = INFO rootLogger.appenderRef.console.ref = ConsoleAppender rootLogger.appenderRef.rolling.ref = RollingFileAppender # 如果你只想改变 Flink 的日志行为则可以取消如下的注释部分 #logger.flink.name = org.apache.flink #logger.flink.level = INFO # 下面几行将公共 libraries 或 connectors 的日志级别保持在 INFO 级别。 # root logger 的配置不会覆盖此处配置。 # 你必须手动修改这里的日志级别。 logger.pekko.name = org.apache.pekko logger.pekko.level = INFO logger.kafka.name= org.apache.kafka logger.kafka.level = INFO logger.hadoop.name = org.apache.hadoop logger.hadoop.level = INFO logger.zookeeper.name = org.apache.zookeeper logger.zookeeper.level = INFO # 将所有 info 级别的日志输出到 console appender.console.name = ConsoleAppender appender.console.type = CONSOLE appender.console.layout.type = PatternLayout appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n # 将所有 info 级别的日志输出到指定的 rolling file appender.rolling.name = RollingFileAppender appender.rolling.type = RollingFile appender.rolling.append = false appender.rolling.fileName = ${sys:log.file} appender.rolling.filePattern = ${sys:log.file}.%i appender.rolling.layout.type = PatternLayout appender.rolling.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n appender.rolling.policies.type = Policies appender.rolling.policies.size.type = SizeBasedTriggeringPolicy appender.rolling.policies.size.size=100MB appender.rolling.strategy.type = DefaultRolloverStrategy appender.rolling.strategy.max = 10 # 关闭 Netty channel handler 中不相关的（错误）警告 logger.netty.name = org.jboss.netty.channel.DefaultChannelPipeline logger.netty.level = OFF 创建dockerfile基础镜像 默认flink是不支持oss的,需要安装plugin\nFROM flink:1.20.2-java11 #支持oss RUN mkdir ${FLINK_HOME}/plugins/oss-fs-hadoop \\ \u0026\u0026 cp ${FLINK_HOME}/opt/flink-oss-fs-hadoop-*.jar ${FLINK_HOME}/plugins/oss-fs-hadoop/ #添加依赖包, mysql cdc, kafka connector, connector-base, table-common, gson #根据实际情况选择，有效减小任务打包体积 RUN wget -P ${FLINK_HOME}/lib/ https://repo1.maven.org/maven2/org/apache/flink/flink-connector-mysql-cdc/3.3.0/flink-connector-mysql-cdc-3.3.0.jar \\ \u0026\u0026 wget -P ${FLINK_HOME}/lib/ https://repo1.maven.org/maven2/org/apache/flink/flink-connector-kafka/3.3.0-1.20/flink-connector-kafka-3.3.0-1.20.jar \\ \u0026\u0026 wget -P ${FLINK_HOME}/lib/ https://repo1.maven.org/maven2/org/apache/flink/flink-connector-base/1.20.2/flink-connector-base-1.20.2.jar \\ \u0026\u0026 wget -P ${FLINK_HOME}/lib/ https://repo1.maven.org/maven2/org/apache/flink/flink-table-common/1.20.2/flink-table-common-1.20.2.jar \\ \u0026\u0026 wget -P ${FLINK_HOME}/lib/ https://repo1.maven.org/maven2/com/google/code/gson/gson/2.10.1/gson-2.10.1.jar 打包任务到镜像 FROM flink-oss-1-20:latest #假设上一步创建的基础镜像叫这个名字 COPY demo-1.0-SNAPSHOT1.jar /opt/flink/usrlib/ #把我们的jar包打入镜像中,也可以挂载volume等方式,需要再内部能访问到 创建jobmanager apiVersion: batch/v1 kind: Job metadata: name: flink-jobmanager spec: parallelism: 1 # 通过设置大于 1 的整型值来开启 Standby JobManager template: metadata: labels: app: flink component: jobmanager spec: restartPolicy: OnFailure containers: - name: jobmanager image: flink-application:2.0 env: - name: POD_IP valueFrom: fieldRef: apiVersion: v1 fieldPath: status.podIP # 下面的 args 参数会使用 POD_IP 对应的值覆盖 config map 中 jobmanager.rpc.address 的属性值。 args: [\"standalone-job\", \"--host\", \"$(POD_IP)\", \"--job-classname\", \"com.example.FlinkCDCApp\", \"--fromSavepoint\", \"file:/flink/storage/savepoints/savepoint-000000-d3bd4e4cc344\", \"--allowNonRestoredState\", \"--job-id\", \"00000000000000000000000000000000\", \"--mysql.tables=AAA\", \"--kafka.topic=flink-custom\"] # 可选参数项: [\"--job-id\", \"\", \"--jars\", \"/path/to/artifact1,/path/to/artifact2\", \"--fromSavepoint\", \"/path/to/savepoint\", \"--allowNonRestoredState\"] ports: - containerPort: 6123 name: rpc - containerPort: 6124 name: blob-server - containerPort: 8081 name: webui livenessProbe: tcpSocket: port: 6123 initialDelaySeconds: 30 periodSeconds: 60 volumeMounts: - name: flink-config-volume mountPath: /opt/flink/conf - name: flink-storage mountPath: /flink/storage securityContext: runAsUser: 9999 # 参考官方 flink 镜像中的 _flink_ 用户，如有必要可以修改 serviceAccountName: flink-sa # 拥有创建、编辑、删除 ConfigMap 权限的 Service 账号 volumes: - name: flink-config-volume configMap: name: flink-config items: - key: config.yaml path: config.yaml - key: log4j-console.properties path: log4j-console.properties - name: flink-storage hostPath: path: /run/desktop/mnt/host/e/flink type: DirectoryOrCreate 创建taskmanager apiVersion: apps/v1 kind: Deployment metadata: name: flink-taskmanager spec: replicas: 2 selector: matchLabels: app: flink component: taskmanager template: metadata: labels: app: flink component: taskmanager spec: containers: - name: taskmanager image: flink-application:2.0 env: args: [\"taskmanager\"] ports: - containerPort: 6122 name: rpc livenessProbe: tcpSocket: port: 6122 initialDelaySeconds: 30 periodSeconds: 60 volumeMounts: - name: flink-config-volume mountPath: /opt/flink/conf/ - name: flink-storage mountPath: /flink/storage securityContext: runAsUser: 9999 # 参考官方 flink 镜像中的 _flink_ 用户，如有必要可以修改 serviceAccountName: flink-sa # 拥有创建、编辑、删除 ConfigMap 权限的 Service 账号 volumes: - name: flink-config-volume configMap: name: flink-config items: - key: config.yaml path: config.yaml - key: log4j-console.properties path: log4j-console.properties - name: flink-storage hostPath: path: /run/desktop/mnt/host/e/flink type: DirectoryOrCreate 注意事项 flink ha机制目前就两种一种是zookeeper,一种是k8s\njobmanager崩溃后任务无法恢复 没有配置ha机制, 如果没有ha机制jobmanager崩溃后需要重新提交任务\ntaskmanager崩溃后任务恢复异常 checkpoint没有配置或者有问题, 配置好checkpoint才能崩溃后回到checkpoint位置进行执行\nkafka 丢数据 丢数据需要再创建sink时配置如下几项,否则会丢数据,甚至发送不成功任务继续进行,不会导致异常\n1.需要配置setDeliveryGuarantee(org.apache.flink.connector.base.DeliveryGuarantee.EXACTLY_ONCE)\n2.配置事务超时需要超过 检查点间隔时间+检查点超时时间\n// Kafka Exactly-Once 配置 String txIdPrefix = params.get(\"kafka.transactional.id.prefix\", \"flink-cdc-tx\"); String txTimeoutMs = params.get(\"kafka.transaction.timeout.ms\", \"30000\"); // 30s，需≤ broker 的 transaction.max.timeout.ms KafkaSink\u003cString\u003e kafkaSink = KafkaSink.\u003cString\u003ebuilder() .setBootstrapServers(kafkaBootstrapServers) .setRecordSerializer(KafkaRecordSerializationSchema.builder() .setTopicSelector(new TopicSelector\u003cString\u003e() { @Override public String apply(String t) { return kafkaTopic; } }) .setValueSerializationSchema(utf8StringSerializer) .build()) .setDeliveryGuarantee(org.apache.flink.connector.base.DeliveryGuarantee.EXACTLY_ONCE) // 确保Exactly-Once语义,不丢数据很重要 .setTransactionalIdPrefix(txIdPrefix) .setProperty(\"retries\", \"3\") // 失败重试次数，配合幂等避免重复 // .setProperty(\"acks\", \"all\") // 所有ISR副本确认后才算成功，提升可靠性 .setProperty(\"enable.idempotence\", \"true\") // 启用幂等写入，重试不产生重复 .setProperty(\"transaction.timeout.ms\", txTimeoutMs) // 单次事务最大存活时间（需≤broker的transaction.max.timeout.ms） .build(); 注意:\n以下属性在构建 KafkaSink 时是必须指定的： Bootstrap servers, setBootstrapServers(String) 消息序列化器（Serializer）, setRecordSerializer(KafkaRecordSerializationSchema) 如果使用DeliveryGuarantee.EXACTLY_ONCE 的语义保证，则需要使用 setTransactionalIdPrefix(String)\n","wordCount":"1349","inLanguage":"zh","datePublished":"2025-09-29T15:31:13+08:00","dateModified":"2025-09-29T15:31:13+08:00","author":{"@type":"Person","name":"Fengbin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://shifengbin.github.io/posts/flink/flink/"},"publisher":{"@type":"Organization","name":"Blog Zone","logo":{"@type":"ImageObject","url":"https://shifengbin.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://shifengbin.github.io/ accesskey=h title="Blog Zone (Alt + H)">Blog Zone</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://shifengbin.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://shifengbin.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://shifengbin.github.io/contact/ title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://shifengbin.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://shifengbin.github.io/posts/>Posts</a></div><h1 class=post-title>Flink k8s中的使用</h1><div class=post-meta>2025-09-29 15:31:13&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;7 分钟&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;1349 字&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;Fengbin</div></header><div class=post-content><h1 id=flink使用>flink使用<a hidden class=anchor aria-hidden=true href=#flink使用>#</a></h1><p>本文讲解的是在k8s中使用flink,摆脱yarn, hdfs等大数据组件</p><h2 id=k8s-部署手动部署ha模式>k8s 部署(手动部署HA模式)<a hidden class=anchor aria-hidden=true href=#k8s-部署手动部署ha模式>#</a></h2><p>想要实现K8S的HA模式必须要有几个条件</p><ol><li>要有能查看,添加,修改,删除configmap权限的账户<div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># flink-service-account.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>flink-namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>flink-namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;configmaps&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;create&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;update&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;delete&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;patch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;pods&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;services&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-role-binding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>flink-namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>flink-namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span></code></pre></div></li><li>配置文件开启高可用模式为kubernetes和配置集群id,检查点和重启策略<div class=highlight><pre tabindex=0 class=chroma><code class=language-properties data-lang=properties><span class=line><span class=cl>    <span class=c1>#高可用配置</span>
</span></span><span class=line><span class=cl>    <span class=na>high-availability.type</span><span class=o>:</span> <span class=s>kubernetes</span>
</span></span><span class=line><span class=cl>    <span class=na>high-availability.storageDir</span><span class=o>:</span> <span class=s>file:///flink/storage/ha</span>
</span></span><span class=line><span class=cl>    <span class=c1>#集群信息</span>
</span></span><span class=line><span class=cl>    <span class=na>kubernetes.cluster-id</span><span class=o>:</span> <span class=s>flink-cluster-001</span>
</span></span><span class=line><span class=cl>    <span class=na>kubernetes.namespace</span><span class=o>:</span> <span class=s>flink-namespace</span>
</span></span><span class=line><span class=cl>    <span class=c1>#状态后端,检查点保存点默认位置,可以配置为oss</span>
</span></span><span class=line><span class=cl>    <span class=na>state.backend.type</span><span class=o>:</span> <span class=s>filesystem   </span>
</span></span><span class=line><span class=cl>    <span class=na>state.checkpoints.dir</span><span class=o>:</span> <span class=s>file:///flink/storage/checkpoints</span>
</span></span><span class=line><span class=cl>    <span class=na>state.savepoints.dir</span><span class=o>:</span> <span class=s>file:///flink/storage/savepoints</span>
</span></span><span class=line><span class=cl>    <span class=c1>#检查点执行配置</span>
</span></span><span class=line><span class=cl>    <span class=na>execution.checkpointing.interval</span><span class=o>:</span> <span class=s>20s</span>
</span></span><span class=line><span class=cl>    <span class=na>execution.checkpointing.max-concurrent-checkpoints</span><span class=o>:</span> <span class=s>1</span>
</span></span><span class=line><span class=cl>    <span class=na>execution.checkpointing.mode</span><span class=o>:</span> <span class=s>EXACTLY_ONCE</span>
</span></span><span class=line><span class=cl>    <span class=na>execution.checkpointing.timeout</span><span class=o>:</span> <span class=s>1min</span>
</span></span><span class=line><span class=cl>    <span class=c1>#重启策略</span>
</span></span><span class=line><span class=cl>    <span class=na>restart-strategy.type</span><span class=o>:</span> <span class=s>fixed-delay</span>
</span></span><span class=line><span class=cl>    <span class=na>restart-strategy.fixed-delay.attempts</span><span class=o>:</span> <span class=s>10</span>
</span></span><span class=line><span class=cl>    <span class=na>restart-strategy.fixed-delay.delay</span><span class=o>:</span> <span class=s>30s</span>
</span></span></code></pre></div></li></ol><h3 id=session模式>session模式<a hidden class=anchor aria-hidden=true href=#session模式>#</a></h3><h4 id=创建命名空间>创建命名空间<a hidden class=anchor aria-hidden=true href=#创建命名空间>#</a></h4><p>我们把flink部署到名称为flink-namespace的命名空间中(创建命名空间<code>kubectl create namespace flink-namespace</code>)</p><h5 id=创建用户并绑定权限kubectl-create--f-flink-service-accountyaml--n-flink-namespace>创建用户并绑定权限(<code>kubectl create -f flink-service-account.yaml -n flink-namespace</code>)<a hidden class=anchor aria-hidden=true href=#创建用户并绑定权限kubectl-create--f-flink-service-accountyaml--n-flink-namespace>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># flink-service-account.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>flink-namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>flink-namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;configmaps&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;create&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;update&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;delete&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;patch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;pods&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;services&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-role-binding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>flink-namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>flink-namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span></code></pre></div><h5 id=配置通过configmap来配置>配置通过configmap来配置<a hidden class=anchor aria-hidden=true href=#配置通过configmap来配置>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|+</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    jobmanager.rpc.address: flink-jobmanager
</span></span></span><span class=line><span class=cl><span class=sd>    taskmanager.numberOfTaskSlots: 1
</span></span></span><span class=line><span class=cl><span class=sd>    blob.server.port: 6124
</span></span></span><span class=line><span class=cl><span class=sd>    jobmanager.rpc.port: 6123
</span></span></span><span class=line><span class=cl><span class=sd>    taskmanager.rpc.port: 6122
</span></span></span><span class=line><span class=cl><span class=sd>    jobmanager.memory.process.size: 1600m
</span></span></span><span class=line><span class=cl><span class=sd>    taskmanager.memory.process.size: 1728m
</span></span></span><span class=line><span class=cl><span class=sd>    parallelism.default: 1
</span></span></span><span class=line><span class=cl><span class=sd>    high-availability.type: kubernetes
</span></span></span><span class=line><span class=cl><span class=sd>    high-availability.storageDir: file:///flink/storage/ha
</span></span></span><span class=line><span class=cl><span class=sd>    kubernetes.cluster-id: flink-cluster-001
</span></span></span><span class=line><span class=cl><span class=sd>    kubernetes.namespace: flink-namespace
</span></span></span><span class=line><span class=cl><span class=sd>    state.backend.type: filesystem
</span></span></span><span class=line><span class=cl><span class=sd>    state.checkpoints.dir: file:///flink/storage/checkpoints
</span></span></span><span class=line><span class=cl><span class=sd>    state.savepoints.dir: file:///flink/storage/savepoints
</span></span></span><span class=line><span class=cl><span class=sd>    execution.checkpointing.interval: 20s
</span></span></span><span class=line><span class=cl><span class=sd>    execution.checkpointing.max-concurrent-checkpoints: 1
</span></span></span><span class=line><span class=cl><span class=sd>    execution.checkpointing.mode: EXACTLY_ONCE
</span></span></span><span class=line><span class=cl><span class=sd>    execution.checkpointing.timeout: 1min
</span></span></span><span class=line><span class=cl><span class=sd>    restart-strategy.type: fixed-delay
</span></span></span><span class=line><span class=cl><span class=sd>    restart-strategy.fixed-delay.attempts: 10
</span></span></span><span class=line><span class=cl><span class=sd>    restart-strategy.fixed-delay.delay: 30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>log4j-console.properties</span><span class=p>:</span><span class=w> </span><span class=p>|+</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 如下配置会同时影响用户代码和 Flink 的日志行为
</span></span></span><span class=line><span class=cl><span class=sd>    rootLogger.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>    rootLogger.appenderRef.console.ref = ConsoleAppender
</span></span></span><span class=line><span class=cl><span class=sd>    rootLogger.appenderRef.rolling.ref = RollingFileAppender
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 如果你只想改变 Flink 的日志行为则可以取消如下的注释部分
</span></span></span><span class=line><span class=cl><span class=sd>    #logger.flink.name = org.apache.flink
</span></span></span><span class=line><span class=cl><span class=sd>    #logger.flink.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 下面几行将公共 libraries 或 connectors 的日志级别保持在 INFO 级别。
</span></span></span><span class=line><span class=cl><span class=sd>    # root logger 的配置不会覆盖此处配置。
</span></span></span><span class=line><span class=cl><span class=sd>    # 你必须手动修改这里的日志级别。
</span></span></span><span class=line><span class=cl><span class=sd>    logger.pekko.name = org.apache.pekko
</span></span></span><span class=line><span class=cl><span class=sd>    logger.pekko.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>    logger.kafka.name= org.apache.kafka
</span></span></span><span class=line><span class=cl><span class=sd>    logger.kafka.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>    logger.hadoop.name = org.apache.hadoop
</span></span></span><span class=line><span class=cl><span class=sd>    logger.hadoop.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>    logger.zookeeper.name = org.apache.zookeeper
</span></span></span><span class=line><span class=cl><span class=sd>    logger.zookeeper.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 将所有 info 级别的日志输出到 console
</span></span></span><span class=line><span class=cl><span class=sd>    appender.console.name = ConsoleAppender
</span></span></span><span class=line><span class=cl><span class=sd>    appender.console.type = CONSOLE
</span></span></span><span class=line><span class=cl><span class=sd>    appender.console.layout.type = PatternLayout
</span></span></span><span class=line><span class=cl><span class=sd>    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 将所有 info 级别的日志输出到指定的 rolling file
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.name = RollingFileAppender
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.type = RollingFile
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.append = false
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.fileName = ${sys:log.file}
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.filePattern = ${sys:log.file}.%i
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.layout.type = PatternLayout
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.policies.type = Policies
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.policies.size.type = SizeBasedTriggeringPolicy
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.policies.size.size=100MB
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.strategy.type = DefaultRolloverStrategy
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.strategy.max = 10
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 关闭 Netty channel handler 中不相关的（错误）警告
</span></span></span><span class=line><span class=cl><span class=sd>    logger.netty.name = org.jboss.netty.channel.DefaultChannelPipeline
</span></span></span><span class=line><span class=cl><span class=sd>    logger.netty.level = OFF  </span><span class=w>
</span></span></span></code></pre></div><h5 id=创建jobmanagerkubectl-apply--f-jobmanager-deploymentyaml--n-flink-namespace>创建jobmanager(<code>kubectl apply -f jobmanager-deployment.yaml -n flink-namespace</code>)<a hidden class=anchor aria-hidden=true href=#创建jobmanagerkubectl-apply--f-jobmanager-deploymentyaml--n-flink-namespace>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># jobmanager-deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>  </span><span class=c># 如果需要更快的恢复，可以设置为2，但通常1个就够了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>flink-sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>apache/flink:1.20.2-scala_2.12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POD_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.podIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 下面的 args 参数会使用 POD_IP 对应的值覆盖 config map 中 jobmanager.rpc.address 的属性值。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;jobmanager&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;$(POD_IP)&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>6123</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rpc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>6124</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>blob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>webui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6123</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/flink/conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/flink/storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>9999</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>log4j-console.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>log4j-console.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/run/desktop/mnt/host/e/flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>DirectoryOrCreate</span><span class=w>
</span></span></span></code></pre></div><h5 id=创建-taskmanagerkubectl-apply--f-flink-taskmanageryaml--n-flink-namespace>创建 taskmanager(<code>kubectl apply -f flink-taskmanager.yaml -n flink-namespace</code>)<a hidden class=anchor aria-hidden=true href=#创建-taskmanagerkubectl-apply--f-flink-taskmanageryaml--n-flink-namespace>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># taskmanager-deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-taskmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>taskmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>  </span><span class=c># 根据您的需求设置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>taskmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>taskmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>flink-sa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>taskmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>apache/flink:1.20.2-scala_2.12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;taskmanager&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>6122</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rpc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6122</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/flink/conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/flink/storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;2&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>9999</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>log4j-console.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>log4j-console.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/run/desktop/mnt/host/e/flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>DirectoryOrCreate</span><span class=w>
</span></span></span></code></pre></div><h5 id=创建service方便访问>创建service方便访问<a hidden class=anchor aria-hidden=true href=#创建service方便访问>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># jobmanager-service.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rpc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6123</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>blob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6124</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>webui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-jobmanager-rest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>jobmanager</span><span class=w>
</span></span></span></code></pre></div><h4 id=application部署oss方式模式>application部署(oss方式模式)<a hidden class=anchor aria-hidden=true href=#application部署oss方式模式>#</a></h4><p>用户要求和session模式一致</p><h5 id=创建配置文件configmap>创建配置文件(configmap)<a hidden class=anchor aria-hidden=true href=#创建配置文件configmap>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|+</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    jobmanager.rpc.address: flink-jobmanager
</span></span></span><span class=line><span class=cl><span class=sd>    taskmanager.numberOfTaskSlots: 1
</span></span></span><span class=line><span class=cl><span class=sd>    blob.server.port: 6124
</span></span></span><span class=line><span class=cl><span class=sd>    jobmanager.rpc.port: 6123
</span></span></span><span class=line><span class=cl><span class=sd>    taskmanager.rpc.port: 6122
</span></span></span><span class=line><span class=cl><span class=sd>    jobmanager.memory.process.size: 1600m
</span></span></span><span class=line><span class=cl><span class=sd>    taskmanager.memory.process.size: 1728m
</span></span></span><span class=line><span class=cl><span class=sd>    #这里是阿里云oss的配置
</span></span></span><span class=line><span class=cl><span class=sd>    fs.oss.accessKeyId: xxx
</span></span></span><span class=line><span class=cl><span class=sd>    fs.oss.accessKeySecret: xxx
</span></span></span><span class=line><span class=cl><span class=sd>    fs.oss.endpoint: xxx
</span></span></span><span class=line><span class=cl><span class=sd>    parallelism.default: 1
</span></span></span><span class=line><span class=cl><span class=sd>    high-availability.type: kubernetes
</span></span></span><span class=line><span class=cl><span class=sd>    high-availability.storageDir: oss://bucketname/flink/storage/ha
</span></span></span><span class=line><span class=cl><span class=sd>    kubernetes.cluster-id: flink-cluster-001
</span></span></span><span class=line><span class=cl><span class=sd>    kubernetes.namespace: flink-namespace
</span></span></span><span class=line><span class=cl><span class=sd>    state.backend.type: filesystem
</span></span></span><span class=line><span class=cl><span class=sd>    state.checkpoints.dir: oss://bucketname/flink/storage/checkpoints
</span></span></span><span class=line><span class=cl><span class=sd>    state.savepoints.dir: oss://bucketname/flink/storage/savepoints
</span></span></span><span class=line><span class=cl><span class=sd>    execution.checkpointing.interval: 20s
</span></span></span><span class=line><span class=cl><span class=sd>    execution.checkpointing.max-concurrent-checkpoints: 1
</span></span></span><span class=line><span class=cl><span class=sd>    execution.checkpointing.mode: EXACTLY_ONCE
</span></span></span><span class=line><span class=cl><span class=sd>    execution.checkpointing.timeout: 1min
</span></span></span><span class=line><span class=cl><span class=sd>    restart-strategy.type: fixed-delay
</span></span></span><span class=line><span class=cl><span class=sd>    restart-strategy.fixed-delay.attempts: 10
</span></span></span><span class=line><span class=cl><span class=sd>    restart-strategy.fixed-delay.delay: 30s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>log4j-console.properties</span><span class=p>:</span><span class=w> </span><span class=p>|+</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 如下配置会同时影响用户代码和 Flink 的日志行为
</span></span></span><span class=line><span class=cl><span class=sd>    rootLogger.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>    rootLogger.appenderRef.console.ref = ConsoleAppender
</span></span></span><span class=line><span class=cl><span class=sd>    rootLogger.appenderRef.rolling.ref = RollingFileAppender
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 如果你只想改变 Flink 的日志行为则可以取消如下的注释部分
</span></span></span><span class=line><span class=cl><span class=sd>    #logger.flink.name = org.apache.flink
</span></span></span><span class=line><span class=cl><span class=sd>    #logger.flink.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 下面几行将公共 libraries 或 connectors 的日志级别保持在 INFO 级别。
</span></span></span><span class=line><span class=cl><span class=sd>    # root logger 的配置不会覆盖此处配置。
</span></span></span><span class=line><span class=cl><span class=sd>    # 你必须手动修改这里的日志级别。
</span></span></span><span class=line><span class=cl><span class=sd>    logger.pekko.name = org.apache.pekko
</span></span></span><span class=line><span class=cl><span class=sd>    logger.pekko.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>    logger.kafka.name= org.apache.kafka
</span></span></span><span class=line><span class=cl><span class=sd>    logger.kafka.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>    logger.hadoop.name = org.apache.hadoop
</span></span></span><span class=line><span class=cl><span class=sd>    logger.hadoop.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>    logger.zookeeper.name = org.apache.zookeeper
</span></span></span><span class=line><span class=cl><span class=sd>    logger.zookeeper.level = INFO
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 将所有 info 级别的日志输出到 console
</span></span></span><span class=line><span class=cl><span class=sd>    appender.console.name = ConsoleAppender
</span></span></span><span class=line><span class=cl><span class=sd>    appender.console.type = CONSOLE
</span></span></span><span class=line><span class=cl><span class=sd>    appender.console.layout.type = PatternLayout
</span></span></span><span class=line><span class=cl><span class=sd>    appender.console.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 将所有 info 级别的日志输出到指定的 rolling file
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.name = RollingFileAppender
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.type = RollingFile
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.append = false
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.fileName = ${sys:log.file}
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.filePattern = ${sys:log.file}.%i
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.layout.type = PatternLayout
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.layout.pattern = %d{yyyy-MM-dd HH:mm:ss,SSS} %-5p %-60c %x - %m%n
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.policies.type = Policies
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.policies.size.type = SizeBasedTriggeringPolicy
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.policies.size.size=100MB
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.strategy.type = DefaultRolloverStrategy
</span></span></span><span class=line><span class=cl><span class=sd>    appender.rolling.strategy.max = 10
</span></span></span><span class=line><span class=cl><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    # 关闭 Netty channel handler 中不相关的（错误）警告
</span></span></span><span class=line><span class=cl><span class=sd>    logger.netty.name = org.jboss.netty.channel.DefaultChannelPipeline
</span></span></span><span class=line><span class=cl><span class=sd>    logger.netty.level = OFF  </span><span class=w>
</span></span></span></code></pre></div><h5 id=创建dockerfile基础镜像>创建dockerfile基础镜像<a hidden class=anchor aria-hidden=true href=#创建dockerfile基础镜像>#</a></h5><p>默认flink是不支持oss的,需要安装plugin</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> flink:1.20.2-java11</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#支持oss</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mkdir <span class=si>${</span><span class=nv>FLINK_HOME</span><span class=si>}</span>/plugins/oss-fs-hadoop <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> cp <span class=si>${</span><span class=nv>FLINK_HOME</span><span class=si>}</span>/opt/flink-oss-fs-hadoop-*.jar <span class=si>${</span><span class=nv>FLINK_HOME</span><span class=si>}</span>/plugins/oss-fs-hadoop/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#添加依赖包, mysql cdc, kafka connector, connector-base, table-common, gson</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>#根据实际情况选择，有效减小任务打包体积</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> wget -P <span class=si>${</span><span class=nv>FLINK_HOME</span><span class=si>}</span>/lib/ https://repo1.maven.org/maven2/org/apache/flink/flink-connector-mysql-cdc/3.3.0/flink-connector-mysql-cdc-3.3.0.jar <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> wget -P <span class=si>${</span><span class=nv>FLINK_HOME</span><span class=si>}</span>/lib/ https://repo1.maven.org/maven2/org/apache/flink/flink-connector-kafka/3.3.0-1.20/flink-connector-kafka-3.3.0-1.20.jar <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> wget -P <span class=si>${</span><span class=nv>FLINK_HOME</span><span class=si>}</span>/lib/ https://repo1.maven.org/maven2/org/apache/flink/flink-connector-base/1.20.2/flink-connector-base-1.20.2.jar <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> wget -P <span class=si>${</span><span class=nv>FLINK_HOME</span><span class=si>}</span>/lib/ https://repo1.maven.org/maven2/org/apache/flink/flink-table-common/1.20.2/flink-table-common-1.20.2.jar <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=o>&amp;&amp;</span> wget -P <span class=si>${</span><span class=nv>FLINK_HOME</span><span class=si>}</span>/lib/ https://repo1.maven.org/maven2/com/google/code/gson/gson/2.10.1/gson-2.10.1.jar<span class=err>
</span></span></span></code></pre></div><h5 id=打包任务到镜像>打包任务到镜像<a hidden class=anchor aria-hidden=true href=#打包任务到镜像>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> flink-oss-1-20:latest   #假设上一步创建的基础镜像叫这个名字</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> demo-1.0-SNAPSHOT1.jar /opt/flink/usrlib/   <span class=c1>#把我们的jar包打入镜像中,也可以挂载volume等方式,需要再内部能访问到</span><span class=err>
</span></span></span></code></pre></div><h5 id=创建jobmanager>创建jobmanager<a hidden class=anchor aria-hidden=true href=#创建jobmanager>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>parallelism</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w> </span><span class=c># 通过设置大于 1 的整型值来开启 Standby JobManager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>component</span><span class=p>:</span><span class=w> </span><span class=l>jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OnFailure</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jobmanager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>flink-application:2.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POD_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.podIP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c># 下面的 args 参数会使用 POD_IP 对应的值覆盖 config map 中 jobmanager.rpc.address 的属性值。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;standalone-job&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--host&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;$(POD_IP)&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--job-classname&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;com.example.FlinkCDCApp&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--fromSavepoint&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;file:/flink/storage/savepoints/savepoint-000000-d3bd4e4cc344&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--allowNonRestoredState&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--job-id&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;00000000000000000000000000000000&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--mysql.tables=AAA&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--kafka.topic=flink-custom&#34;</span><span class=nt>] # 可选参数项</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;--job-id&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;&lt;job id&gt;&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--jars&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;/path/to/artifact1,/path/to/artifact2&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--fromSavepoint&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;/path/to/savepoint&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--allowNonRestoredState&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>6123</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rpc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>6124</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>blob-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8081</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>webui</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6123</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/opt/flink/conf</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/flink/storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>9999</span><span class=w>  </span><span class=c># 参考官方 flink 镜像中的 _flink_ 用户，如有必要可以修改</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>serviceAccountName</span><span class=p>:</span><span class=w> </span><span class=l>flink-sa</span><span class=w> </span><span class=c># 拥有创建、编辑、删除 ConfigMap 权限的 Service 账号</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>items</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>config.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>log4j-console.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>log4j-console.properties</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>flink-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/run/desktop/mnt/host/e/flink</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>DirectoryOrCreate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      
</span></span></span></code></pre></div><h5 id=创建taskmanager>创建taskmanager<a hidden class=anchor aria-hidden=true href=#创建taskmanager>#</a></h5><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl>apiVersion: apps/v1<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>kind: Deployment<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>metadata:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  name: flink-taskmanager<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>spec:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  replicas: <span class=m>2</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  selector:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    matchLabels:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      app: flink<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      component: taskmanager<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>  template:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    metadata:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      labels:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        app: flink<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        component: taskmanager<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    spec:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      containers:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - name: taskmanager<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        image: flink-application:2.0<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        env:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        args: <span class=o>[</span><span class=s2>&#34;taskmanager&#34;</span><span class=o>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        ports:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        - containerPort: <span class=m>6122</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          name: rpc<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        livenessProbe:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          tcpSocket:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            port: <span class=m>6122</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          initialDelaySeconds: <span class=m>30</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          periodSeconds: <span class=m>60</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        volumeMounts:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        - name: flink-config-volume<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          mountPath: /opt/flink/conf/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        - name: flink-storage<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          mountPath: /flink/storage<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        securityContext:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          runAsUser: <span class=m>9999</span>  <span class=c1># 参考官方 flink 镜像中的 _flink_ 用户，如有必要可以修改</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      serviceAccountName: flink-sa <span class=c1># 拥有创建、编辑、删除 ConfigMap 权限的 Service 账号</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      volumes:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - name: flink-config-volume<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        configMap:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          name: flink-config<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          items:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          - key: config.yaml<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            path: config.yaml<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          - key: log4j-console.properties<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>            path: log4j-console.properties<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>      - name: flink-storage<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        hostPath:<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          path: /run/desktop/mnt/host/e/flink<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>          type: DirectoryOrCreate<span class=err>
</span></span></span></code></pre></div><h2 id=注意事项>注意事项<a hidden class=anchor aria-hidden=true href=#注意事项>#</a></h2><p>flink ha机制目前就两种一种是zookeeper,一种是k8s</p><h3 id=jobmanager崩溃后任务无法恢复>jobmanager崩溃后任务无法恢复<a hidden class=anchor aria-hidden=true href=#jobmanager崩溃后任务无法恢复>#</a></h3><p>没有配置ha机制, 如果没有ha机制jobmanager崩溃后需要重新提交任务</p><h3 id=taskmanager崩溃后任务恢复异常>taskmanager崩溃后任务恢复异常<a hidden class=anchor aria-hidden=true href=#taskmanager崩溃后任务恢复异常>#</a></h3><p>checkpoint没有配置或者有问题, 配置好checkpoint才能崩溃后回到checkpoint位置进行执行</p><h3 id=kafka-丢数据>kafka 丢数据<a hidden class=anchor aria-hidden=true href=#kafka-丢数据>#</a></h3><p>丢数据需要再创建sink时配置如下几项,否则会丢数据,甚至发送不成功任务继续进行,不会导致异常</p><p>1.需要配置setDeliveryGuarantee(org.apache.flink.connector.base.DeliveryGuarantee.EXACTLY_ONCE)</p><p>2.配置事务超时需要超过 检查点间隔时间+检查点超时时间</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>        </span><span class=c1>// Kafka Exactly-Once 配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>txIdPrefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>params</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;kafka.transactional.id.prefix&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;flink-cdc-tx&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>txTimeoutMs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>params</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;kafka.transaction.timeout.ms&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;30000&#34;</span><span class=p>);</span><span class=w> </span><span class=c1>// 30s，需≤ broker 的 transaction.max.timeout.ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>KafkaSink</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>kafkaSink</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>KafkaSink</span><span class=p>.</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=n>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setBootstrapServers</span><span class=p>(</span><span class=n>kafkaBootstrapServers</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setRecordSerializer</span><span class=p>(</span><span class=n>KafkaRecordSerializationSchema</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>setTopicSelector</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>TopicSelector</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>apply</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=k>return</span><span class=w> </span><span class=n>kafkaTopic</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>setValueSerializationSchema</span><span class=p>(</span><span class=n>utf8StringSerializer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>build</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setDeliveryGuarantee</span><span class=p>(</span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>flink</span><span class=p>.</span><span class=na>connector</span><span class=p>.</span><span class=na>base</span><span class=p>.</span><span class=na>DeliveryGuarantee</span><span class=p>.</span><span class=na>EXACTLY_ONCE</span><span class=p>)</span><span class=w> </span><span class=c1>// 确保Exactly-Once语义,不丢数据很重要</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setTransactionalIdPrefix</span><span class=p>(</span><span class=n>txIdPrefix</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setProperty</span><span class=p>(</span><span class=s>&#34;retries&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;3&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 失败重试次数，配合幂等避免重复</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// .setProperty(&#34;acks&#34;, &#34;all&#34;) // 所有ISR副本确认后才算成功，提升可靠性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setProperty</span><span class=p>(</span><span class=s>&#34;enable.idempotence&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 启用幂等写入，重试不产生重复</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>setProperty</span><span class=p>(</span><span class=s>&#34;transaction.timeout.ms&#34;</span><span class=p>,</span><span class=w> </span><span class=n>txTimeoutMs</span><span class=p>)</span><span class=w> </span><span class=c1>// 单次事务最大存活时间（需≤broker的transaction.max.timeout.ms）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>注意:</p><p>以下属性在构建 KafkaSink 时是必须指定的：
Bootstrap servers, setBootstrapServers(String)
消息序列化器（Serializer）, setRecordSerializer(KafkaRecordSerializationSchema)
如果使用DeliveryGuarantee.EXACTLY_ONCE 的语义保证，则需要使用 setTransactionalIdPrefix(String)</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://shifengbin.github.io/tags/flink/>Flink</a></li></ul><nav class=paginav><a class=next href=https://shifengbin.github.io/posts/others/task/><span class=title>下一页 »</span><br><span>简单的数据库任务队列设计</span></a></nav></footer><div id=__comments_box></div><script>let commentID="__comments_box";function getThemeName(e){let t=e=="dark"?"photon-dark":"github-light";return t}function resetComment(e){let t=document.querySelector("#__comments_box iframe");console.log(e,getThemeName(e)),t.contentWindow.postMessage({type:"set-theme",theme:getThemeName(e)},"https://utteranc.es")}function addComment(){let t=document.body.className.includes("dark")?"photon-dark":"github-light";var n=document.getElementById(commentID),e=document.createElement("script");e.src="https://utteranc.es/client.js",e.setAttribute("repo","shifengbin/shifengbin.github.io"),e.setAttribute("issue-term","pathname"),e.setAttribute("theme",t),e.setAttribute("crossorigin","anonymous"),e.setAttribute("async",""),n.appendChild(e)}function initThemeObserver(){window.themeOberver==void 0&&(window.themeOberver=[]),themeOberver.push(resetComment)}initThemeObserver(),addComment()</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://shifengbin.github.io/>Blog Zone</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{let e="dark";document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light"),e="light"):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"),e="dark");for(let t of window.themeOberver)t(e)})</script></body></html>